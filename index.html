<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>ANKI Track builder</title>
  </head>
  <script type="text/javascript">
    var gridSize = 30;
    var halfGrid = gridSize/2;

    var context;
    var canvas;
    var body;
    var goodTracks = [];
    var trackIndex = 0;
    var trackInterval;

    var drawing = false;
    var working = false;

    //initalize
    function onload(){
      body = document.getElementById('body');
      var h = body.clientHeight;
      var w = body.clientWidth;
      canvas = document.getElementById('canvas');
      canvas.height = h;
      canvas.width = w;
      context = canvas.getContext('2d');
      drawgrid();
    }

    //draw grid
    function drawgrid(){
      var h = body.clientHeight;
      var w = body.clientWidth;

      context.fillStyle = "#FFFFFF";

      context.strokeStyle = "#AAAAAA";

      context.fillRect(0,0,w,h);

      context.beginPath();
      for(var x = 0; x < w; x+=gridSize){
        context.moveTo(x,0);
        context.lineTo(x,h);
      }
      for(var y = 0; y < h; y+=gridSize){
        context.moveTo(0,y);
        context.lineTo(w,y);
      }
      context.stroke();
    }

    //draw track
    function draw(track){
      drawgrid()
      offsetx = (canvas.width/2);
      offsety = (canvas.height/2);
      offsetx -= offsetx%gridSize;
      offsety -= offsety%gridSize;
      for(var i = 0; i < track.pieces.length; i++){
        context.beginPath();
        if(track.pieces[i].type == -1){
          context.fillStyle = "#00FF00";
        } else if(track.pieces[i].type == 0){
          context.fillStyle = "#FFFFFF";
        } else if(track.pieces[i].type == 1){
          context.fillStyle = "#ffa0a0";
        } else if(track.pieces[i].type == 2){
          context.fillStyle = "#ff5a5a";
        } else if(track.pieces[i].type == 4){
          context.fillStyle = "#FF00FF";
        } else if(track.pieces[i].type == 6){
          context.fillStyle = "#FFFF00";
        } else {
          context.fillStyle = "#FFFFFF";
        }

        context.strokeStyle = "rgb(0,0,0)";

        context.fillRect(offsetx+(track.pieces[i].pos[0]*gridSize),offsety+(track.pieces[i].pos[1]*gridSize),gridSize,gridSize);
        if(track.pieces[i].type == 4){
          context.fillRect(offsetx+((track.pieces[i].pos[0]-track.pieces[i].dir[0])*gridSize),offsety+((track.pieces[i].pos[1]-track.pieces[i].dir[1])*gridSize),gridSize,gridSize);
        }
        context.moveTo(offsetx+(track.pieces[i].pos[0]*gridSize)+halfGrid,offsety+(track.pieces[i].pos[1]*gridSize)+halfGrid);
        context.lineTo(offsetx+(track.pieces[i].pos[0]*gridSize)+((track.pieces[i].dir[0]*halfGrid)+halfGrid),offsety+(track.pieces[i].pos[1]*gridSize)+((track.pieces[i].dir[1]*halfGrid))+halfGrid);
        context.stroke();
      }
    }

    //run track generation
    function threadGen(){
      var time;
      if(!working){
        goodTracks = [];
        working = true;
        if(trackInterval)clearInterval(trackInterval);
        trackInterval = setInterval(drawGoodTracks, 500);

        time = Date.now();
        if (typeof(w) == "undefined") {
            w = new Worker("./middle.js");
        }

        function filter(track){
          var good = true;
          var path = track.path+track.path;
          for(var y = 0; y < goodTracks.length && good; y++){
            if(path.includes(goodTracks[y].path) && goodTracks[y].path.length == track.path.length){
              good = false;
            }
          }
          if(good) {
            goodTracks.push(track);
          }
        }
        function stringify(p){
          var s=' ';
          switch (p.type) {
            case -1:
              s = 's';
              break;
            case 0:
              s = 's';
              break;
            case 1:
              s = 'c';
              break;
            case 2:
              s = 'c';
              break;
            case 4:
              s = 'j';
              break;
            case 6:
              s = 'b';
              break;
          }
          return s;
        }
        function drawGoodTracks(){
          if(!drawing){
            drawing = true;
            if(trackIndex < goodTracks.length) draw(goodTracks[trackIndex]);
            trackIndex++;
            if(trackIndex >= goodTracks.length){
              trackIndex = 0;
            }
            drawing = false
          }
        }

        // tell worker piece pool
        console.log('start');
        //             S  L  R  r j i s
        w.postMessage([10,10,10,0,2,0,0]);

        w.onmessage = function(event){
          if(event.data.type == 0){
            goodTracks = goodTracks.concat(event.data.tracks);
            console.log('tracks :' + event.data.tracks.length);
          }
          else if(event.data.type == 1){
          //  goodTracks = event.data.tracks;
            console.log('tracks :' + goodTracks.length);

            working = false;
            //loop drawing good tracks
            if(trackInterval)clearInterval(trackInterval);
            trackInterval = setInterval(drawGoodTracks, 100);
          }
        };
      }
    }
  </script>
  <style media="screen">
    body{
      height: 100vh;
      width: 100vw;
      padding: 0;
      margin: 0;
    }
    ._floatingButton{
      position:fixed;
    }

    ._diamond {
      transform: rotate(45deg);
    }
    ._diamond button{
      padding: 0;
      margin: 0 -2px;
    }
    ._diamond div {
      height: 40px;
    }
    ._diamond span{
      position: fixed;
      transform: rotate(-45deg) translate(0px, -20px);
      height: 40px;
      width: 40px;
    }

    ._floatingButton input, ._floatingButton button{
      background-color: orange;
      border: none;
      font-weight: bold;
      font-size: 20px;
      min-width: 40px;
      min-height: 40px;
      border-radius: 5px;
    }

    ._roundtop {
      border-top-left-radius:50% !important;
      border-top-right-radius:50% !important;
    }
    ._roundbottom {
        border-bottom-left-radius:50% !important;
        border-bottom-right-radius:50% !important;
    }
  </style>
  <body id="body" onload="onload();">
    <canvas id="canvas"></canvas>
    <span class="_floatingButton" style="top:10px; left:10px;">
      <input type="button" class="_roundtop _roundbottom" name="" value="S"/>
      <input type="button" class="_roundtop _roundbottom" name="" value="L"/>
      <input type="button" class="_roundtop _roundbottom" name="" value="N"/>
      <input type="button" class="_roundtop _roundbottom" name="" value="C"/>
      <input type="button" class="_roundtop _roundbottom" onclick="threadGen()" name="" value="G"/>
    </span>
    <span class="_floatingButton" style="top:10px; right:10px; text-align:right;">
      <div class="_diamond" style="padding-top: 20px; padding-right: 10px;">
        <div class="">
          <button type="button" class="" name="" style=""><span>&uarr;</span></button>
          <button type="button" class="" name="" style=""><span>&rarr;</span></button>
        </div>
        <div class="">
          <button type="button" class="" name="" style=""><span>&larr;</span></button>
          <button type="button" class="" name="" style=""><span>&darr;</span></button>
        </div>
      </div>
      <input type="button" name="" class="_roundtop" value="+"/><br>
      <input type="button" name="" class="_roundbottom" value="-"/><br>
      <input type="button" name="" class="_roundtop _roundbottom" value="L"/><br>
    </span>
</body>
</html>
